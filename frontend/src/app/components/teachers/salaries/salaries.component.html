<div class="salary-container">
  <h2>Salaries</h2>

  <div class="filters-card">
    <div class="filter-item">
      <label>Select Month & Year:</label>
      <input
        type="month"
        [(ngModel)]="selectedMonthYear"
        (change)="onMonthSelect()"
      />
    </div>

    <div class="filter-item">
      <label>Select Department:</label>
      <select
        [(ngModel)]="selectedDepartment"
        (change)="filterTeachers()"
        [disabled]="!selectedMonthYear"
      >
        <option value="All">All</option>
        @for (dept of departments; track dept) {
          <option [value]="dept">{{ dept }}</option>
        }
      </select>
    </div>

    <div class="filter-item search">
      <label>Search Teacher:</label>
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (input)="filterTeachers()"
        placeholder="Search by ID/Name"
        [disabled]="!selectedMonthYear"
      />
    </div>
  </div>

  @if (selectedMonthYear && filteredTeachers.length) {
    <table>
      <thead>
        <tr>
          <th>S.No</th>
          <th>Teacher ID</th>
          <th>Full Name</th>
          <th>Department</th>
          <th>Designation</th>
          <th>Joining Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        @for (teacher of filteredTeachers; track teacher; let i = $index) {
          <tr>
            <td>{{ i + 1 }}</td>
            <td>{{ teacher.teacherId }}</td>
            <td>{{ teacher.fullName }}</td>
            <td>{{ teacher.department }}</td>
            <td>{{ teacher.designation || 'Teacher' }}</td>
            <td>{{ teacher.joiningDate | date: 'mediumDate' }}</td>
            <td class="actions">
              <i class="fa fa-eye" (click)="viewPayslip(teacher)"></i>
              <i class="fa fa-edit" (click)="openEditModal(teacher)"></i>
              <i class="fa fa-download" (click)="downloadPayslip(teacher)"></i>
            </td>
          </tr>
        }
      </tbody>
    </table>
  }

  @if (selectedMonthYear && !filteredTeachers.length) {
    <div>
      <p>No teachers found for selected filters.</p>
    </div>
  }

  <!-- Payslip & Edit Modal -->
  @if (showPayslipModal || showEditModal) {
    <div class="modal">
      <div class="modal-content payslip-lg">
        @if (!showEditModal) {
          <h2>PAYSLIP {{ selectedMonth | uppercase }} {{ selectedYear }}</h2>
        }
        @if (showEditModal) {
          <h2>EDIT PAYSLIP {{ selectedMonth | uppercase }} {{ selectedYear }}</h2>
        }

        <p>
          {{ schoolProfile?.name || 'School Name' }}<br />
          {{ schoolProfile?.address }},
          {{ schoolProfile?.city }},
          {{ schoolProfile?.state }}
        </p>

        <div class="payslip-section">
          <div class="row">
            <strong>Teacher Number:</strong>
            {{ selectedTeacher?.teacherId }}
          </div>
          <div class="row">
            <strong>Teacher Name:</strong>
            {{ selectedTeacher?.fullName }}
          </div>
          <div class="row">
            <strong>Date Joined:</strong>
            {{ selectedTeacher?.joiningDate | date: 'mediumDate' }}
          </div>
          <div class="row">
            <strong>Department:</strong>
            {{ selectedTeacher?.department }}
          </div>
        </div>

        <div class="payslip-section">
          <div class="row">
            <strong>Payment Mode:</strong>
            Bank Transfer
          </div>
          <div class="row">
            <strong>Bank:</strong>
            {{ selectedTeacher?.bankName || '-' }}
          </div>
          <div class="row">
            <strong>IFSC:</strong>
            {{ selectedTeacher?.bankIfsc || '-' }}
          </div>
        </div>

        <div class="payslip-section">
          <div class="row">
            <strong>Bank Account:</strong>
            {{ selectedTeacher?.bankAccount || '-' }}
          </div>
          <div class="row">
            <strong>PAN:</strong>
            {{ selectedTeacher?.pan || '-' }}
          </div>
          <div class="row">
            <strong>UAN:</strong>
            {{ selectedTeacher?.uan || '-' }}
          </div>
          <div class="row">
            <strong>PF Number:</strong>
            {{ selectedTeacher?.pfNumber || '-' }}
          </div>
        </div>

        <h4>SALARY DETAILS</h4>

        <!-- VIEW MODE -->
        @if (!showEditModal && selectedTeacher) {
          <table class="salary-breakup">
            <tr>
              <th>EARNINGS</th>
              <th>AMOUNT</th>
              <th>DEDUCTIONS</th>
              <th>AMOUNT</th>
            </tr>
            <tr>
              <td>Basic</td>
              <td>₹{{ selectedTeacher.basicSalary | number: '1.2-2' }}</td>
              <td>Other Deductions</td>
              <td>₹{{ selectedTeacher.deductions | number: '1.2-2' }}</td>
            </tr>
            <tr>
              <td>Allowance</td>
              <td>₹{{ selectedTeacher.allowance | number: '1.2-2' }}</td>
              <td></td>
              <td></td>
            </tr>
            <tr class="total-row">
              <td>Total Earnings (A)</td>
              <td>
                ₹{{
                  (selectedTeacher.basicSalary || 0) +
                    (selectedTeacher.allowance || 0)
                    | number: '1.2-2'
                }}
              </td>
              <td>Total Deductions (B)</td>
              <td>
                ₹{{ selectedTeacher.deductions | number: '1.2-2' }}
              </td>
            </tr>
          </table>
        }

        <!-- EDIT MODE -->
        @if (showEditModal && selectedTeacher) {
          <div>
            <table class="salary-breakup">
              <tr>
                <th>Component</th>
                <th>Amount</th>
              </tr>
              <tr>
                <td>Basic</td>
                <td>
                  <input type="number" [(ngModel)]="basicSalary" />
                </td>
              </tr>
              <tr>
                <td>Allowance</td>
                <td>
                  <input type="number" [(ngModel)]="allowance" />
                </td>
              </tr>
              <tr>
                <td>Deductions</td>
                <td>
                  <input type="number" [(ngModel)]="deductions" />
                </td>
              </tr>
            </table>
          </div>
        }

        <div class="net-pay">
          <p>
            <strong>Net Salary Payable ( A - B ):</strong>
            ₹{{ selectedNetSalary | number: '1.2-2' }}
          </p>
        </div>

        <p class="notes">
          <em>
            Note: All amounts displayed in this payslip are in INR.<br />
            *This is a system generated salary slip and does not require
            signature.
          </em>
        </p>

        <div class="modal-buttons">
          @if (showEditModal) {
            <button (click)="savePayslip()">Save</button>
          }
          <button (click)="closeModal()">Close</button>
        </div>
      </div>
    </div>
  }
</div>